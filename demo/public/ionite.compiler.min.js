if("undefined"==typeof window)var platform_get_input=require("prompt-sync")({sigint:!0});else var platform_get_input=window.prompt;let repl_running=!0,repl_debug_enabled=!1,repl_log_to_console=!0,repl_log_buffer="",repl_log=e=>{repl_log_buffer+=e+"\n",repl_log_to_console&&console.log(e)},repl_input=platform_get_input;const REPLLifecycle={init(){repl_debug_enabled&&repl_log("(ReplLifeCycle) init() called")},terminate(){repl_log("(ReplLifeCycle) terminate() called"),process.exit(0)}},get_compiler_state=()=>({finished:!repl_running,debug_enabled:repl_debug_enabled}),repl_clear_buffer=()=>repl_log_buffer="",split_into_args=e=>e.split(" "),sanitize_line=e=>e.trim().replace("\n",""),repl_terminate=REPLLifecycle.terminate,debug=e=>repl_debug_enabled?repl_log(`(ReplInternal) ${e}`):null,success=e=>repl_log(`(RSuccess): ${e}`),set_log_function=e=>repl_log=e,arg_required=e=>error(`argument required: ${e}`),args_assert=(e,n,r=!0)=>e.length<n.length?(arg_required(n),!1):!(e.length>n.length)||!r||(error("too much arguments"),!1),function_call_internal=(e,n)=>{debug(`${e}(${as_safe_type(n)}) called`),internal_functionss[e](n)},function_push_instruction=e=>{"begin"!==e[0]&&"end"!==e[0]&&function_stack[current_func].push({name:e[0],args:e.slice(1)})},error=(e,n)=>{repl_log(`(IonError): ${e}`),n&&process.exit(-1)},as_safe_type=e=>{let n=typeof e;return"string"===n||"boolean"===n||"number"===n||"bigint"===n?e:"function"===n?"?function":"undefined"===n?"nilval":Array.isArray(e)&&0===e.length?"0":JSON.stringify(e)},expand_variables=e=>{let n=e;return e.map(e=>{Object.entries(variable_stack).forEach(([e,r])=>{n.forEach(function(t,l){t.includes(`$${e}`)&&(n[l]=t.replace(`$${e}`,r))})})}),n};let function_stack={__main__:[]},variable_stack={},current_func="__main__";const internal_functionss={dump(){repl_log(`current function: ${current_func}`),repl_log(JSON.stringify(function_stack,null,2)),repl_log(`
variable stack dump:`),repl_log(JSON.stringify(variable_stack,null,2))},set(e){let n=e.join(" ").split("="),r=n[0],t=n[1];if(!r){error("expression requires an lhs (var_name)");return}if(!t){error("expression requires an rhs (var_value)");return}r=r.trim(),"?input"===(t=t.trim())&&(t=repl_input("(Ionite) Ask? ")),variable_stack[r]=t,debug(`storing variable ${r}: ${t}`)},begin(e){if(!args_assert(e,["function? string"]))return!1;let n=e[0];function_stack[n]=[],current_func=n,debug(`start function '${n}'`)},end(){debug(`end function '${current_func="__main__"}'`)},call(e){if(args_assert(e,["function? string"])){if(!(e[0]in function_stack))return error(`undefined function '${e[0]}'`)}},print(e){args_assert(e,["message? string"],!1)&&repl_log(expand_variables(e).join(" "))},__exit__(){repl_terminate()},__debug__(e){args_assert(e,["should_enable? bool"],!1)&&(repl_debug_enabled="true"==e[0],debug("debug info enabled"))}},parse_line=e=>{let n=split_into_args(sanitize_line(e));if(n.length,""!==n[0]&&!n[0].startsWith("#")){if(!(n[0]in internal_functionss)){error(`undefined function/variable '${n[0]}'`);return}function_call_internal(n[0],n.slice(1)),function_push_instruction(n)}},parse=e=>{let n=e.split("\n");for(i=0;i<n.length;i++)parse_line(n[i])},IoniteRepl={functions:{call_internal:function_call_internal},config:{set_log_to_console:e=>repl_log_to_console=e},lifecycle:REPLLifecycle,set_log_function:set_log_function,get_output_buffer:()=>repl_log_buffer,get_state:get_compiler_state,eval:parse,eval_line:parse_line};"object"==typeof process&&(module.exports=IoniteRepl);